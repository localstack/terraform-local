on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

name: Build and Test
jobs:
  build_test:
    strategy:
      matrix:
        tf-version: ["1.5.7", "latest"]
    timeout-minutes: 30
    runs-on: ubuntu-latest
    env:
      AWS_DEFAULT_REGION: us-east-1
      DNS_ADDRESS: 127.0.0.1

    steps:
    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ matrix.tf-version}}
    - name: Check out code
      uses: actions/checkout@v3
    - name: Pull LocalStack Docker image
      run: docker pull localstack/localstack &
    - name: Set up Python 3.11
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: make install
    - name: Run code linter
      run: make lint
    - name: Run tests
      run: make test
